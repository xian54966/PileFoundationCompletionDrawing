# 桩位偏差竣工图编制系统

## 项目简介

本系统用于实现桩基位置偏差的可视化标注，通过对比设计位置和实测位置，生成偏差数据并进行可视化展示。

## 最新更新

### 2025-03-26更新
- **添加高程显示功能**：
  - 实测数据加载时现在会读取高程值
  - 在桩基偏差绘制时，会在桩基圆中显示实测点的高程值
  - 高程值以"H=xxx.xxx"的格式显示，使用青色突出显示
  - 该功能为工程测量提供了额外的标高信息，使图纸更加完整

### 2025-03-25更新
- **改进CAD图纸打开状态检查**：
  - 添加了严格的文档对象验证机制，确保CAD图纸真正打开成功
  - 修复了AutoCAD启动但未打开文档时出现误报"打开成功"的问题
  - 添加了详细的错误提示和操作指南，指导用户正确打开图纸
  - 增强了对CAD连接状态的监控和日志记录，提供更清晰的错误信息

### 2025-03-24更新
- **优化了CAD窗口激活的时机和流程**：
  - 提前CAD窗口激活时机，在显示用户操作指南前先激活CAD窗口
  - 改进CAD窗口识别和匹配机制，通过图纸名称精确定位目标窗口
  - 简化了用户选择流程，避免了多次切换窗口的不便

### 2025-03-23更新
- **改进了CAD窗口激活和选择过程**：
  - 添加了详细的日志记录，可以跟踪CAD窗口激活和实体选择的每一步
  - 修复了选择过程中的变量作用域问题
  - 改进了实体过滤方法，解决了COM接口过滤器错误

- **增强了错误处理**：
  - 添加了更多的异常捕获和处理
  - 改进了状态反馈，实时显示操作状态
  - 使用日志框实时显示选择过程中的关键步骤

## 主要功能

1. **打开CAD图纸**：加载并操作CAD图纸
2. **CAD界面交互**：直接在CAD界面选择桩基圆圈进行处理
3. **图层选择与筛选**：支持选择特定图层的桩基实体
4. **实体类型选择**：可选择从圆形实体或点实体中提取设计点位
5. **加载实测数据**：从CSV或Excel文件中加载实测数据
6. **点位匹配**：按桩号或最近距离匹配设计点和实测点
7. **可视化偏差**：在CAD图纸中以箭头和颜色标注偏差
8. **统计分析**：创建偏差统计表，对桩基位置偏差进行分析
9. **结果导出**：保存标注后的CAD图纸和导出偏差数据

## 新增功能：CAD交互选择桩基

最新版本增加了CAD交互式选择桩基功能，使点位提取更智能化：

- **直接CAD交互**：用户可以在CAD界面中直接选择桩基圆圈，系统会自动识别所在图层
- **图层智能识别**：基于用户选择，自动识别图层并提取同图层的所有桩基圆圈
- **实时高亮显示**：高亮显示选中的实体，提供直观的视觉反馈
- **自动恢复**：保存图纸时会自动清除高亮显示，保持图纸整洁

## 技术特点

1. **智能识别圆心点**：从桩基圆圈中提取圆心作为设计点位，更符合工程实际
2. **自动识别桩号**：自动查找附近文本作为桩号标识
3. **多层高亮显示**：不同颜色表示不同级别的偏差
4. **用户偏好保存**：记住用户上次的设置，提高工作效率
5. **健壮的错误处理**：完善的异常处理和日志记录

## 系统要求

- Windows操作系统
- AutoCAD 2010或以上版本
- Python 3.6或以上版本

## 安装与使用

1. 安装依赖库：
```
pip install -r requirements.txt
```

2. 运行程序：
```
python main.py
```

3. 使用步骤：
   - 打开CAD图纸
   - 使用"在CAD中选择"按钮选择桩基圆圈，或使用"刷新图层"后选择图层
   - 加载实测数据
   - 执行点位匹配、可视化偏差等操作
   - 导出结果

## 注意事项

- 使用前确保AutoCAD已经启动
- 图层名称应避免使用特殊字符
- 实测数据格式应包含桩号、X坐标、Y坐标以及高程四列
- CASS格式数据为：点号,编码,Y坐标,X坐标,高程

## 开发说明

系统由三个主要模块组成：
- `cad_utils.py`：提供与AutoCAD交互的功能
- `data_processor.py`：处理数据匹配和偏差计算
- `visualization.py`：实现偏差的可视化展示
- `main.py`：主程序和用户界面

## 更新日志

### v1.1.0 (2023-08-15)
- 新增CAD界面交互选择桩基功能
- 增加图层选择和实体类型筛选
- 改进点位提取逻辑，从圆形实体提取圆心作为设计点位
- 增加高亮显示选中实体功能
- 增加用户偏好设置保存功能

### v1.0.0 (2023-06-10)
- 初始版本发布

## 故障排除

如果在使用过程中遇到问题，请检查以下几点：

1. **CAD连接问题**：
   - 确保已安装兼容版本的AutoCAD且已正常启动
   - 查看程序日志中是否有CAD连接相关的错误信息
   - 尝试重新启动程序和AutoCAD
   - **重要**: 如果出现"打开成功"提示但实际图纸未打开的情况，请先在AutoCAD内手动打开一个图纸，然后再使用本程序打开目标图纸

2. **图纸打开问题**：
   - 如果系统提示"打开成功"但未看到图纸，请检查AutoCAD是否有未处理的对话框
   - 确保CAD文件格式与您的AutoCAD版本兼容
   - 如果持续出现问题，尝试先在AutoCAD中手动打开该图纸，再使用本程序
   - 检查日志中是否有提示"无法获取文档对象"等错误信息

3. **选择实体问题**：
   - 如果选择窗口弹出后无法激活CAD窗口，请手动切换到CAD窗口
   - 选择过程中查看日志窗口，了解当前操作状态
   - 如果选择不成功，请确保CAD中有可见的圆形实体

4. **查看日志文件**：
   - 程序运行日志保存在应用程序目录下的`application.log`文件中
   - CAD操作日志保存在`cad_operations.log`文件中
   - 日志文件可帮助诊断问题和错误

## 开发者信息

本系统使用Python开发，主要依赖以下库：
- tkinter：用于构建图形用户界面
- pyautocad：用于与AutoCAD进行交互
- pandas：用于数据处理和分析
- matplotlib：用于数据可视化

## 联系方式

如有问题或建议，请联系开发团队。 